<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zuckabot â€” Claim Portal (Live)</title>
<style>
  :root{
    --primary:#00ff00; --bg:#0a0a0a; --card:#111; --text:#fff; --muted:#9aa; --accent:#ff9900; 
    --danger:#ff4444; --success:#00C851; --glass: rgba(255,255,255,0.03);
  }
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:1rem;line-height:1.45;}
  a{color:var(--primary)}
  header{max-width:1100px;margin:0 auto 1rem;padding:0 1rem;}
  h1{color:var(--primary);margin:6px 0;font-size:2.2rem;}
  h2{margin:6px 0;color:#fff;font-size:1.25rem}
  .card{background:linear-gradient(180deg,var(--card),rgba(0,0,0,0.35));border-radius:10px;padding:1.2rem;margin:1rem auto;max-width:1100px;box-shadow:0 10px 30px rgba(0,0,0,.7);text-align:left;border:1px solid rgba(255,255,255,0.02);}
  .inline{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;}
  .muted{color:var(--muted);font-size:0.95rem;}
  button{padding:10px 14px;border-radius:9px;border:none;cursor:pointer;font-weight:700;margin:6px;}
  .btn-accent{background:var(--accent);color:#000;}
  .btn-primary{background:var(--primary);color:#000;}
  .btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04);}
  input, textarea{padding:9px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:var(--text);width:100%;}
  .small{font-size:0.9rem;color:var(--muted);}
  .address{font-family:monospace;font-size:13px;word-break:break-all;color:var(--muted)}
  footer{color:var(--muted);text-align:center;margin-top:1rem;font-size:0.9rem;}
  .flex-col{display:flex;flex-direction:column;gap:8px;}
  .stat{background:var(--glass);padding:8px;border-radius:8px;}
  .copy-btn{padding:6px 8px;border-radius:8px;background:#0f0f0f;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted);}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999;}
  .modal{background:#0a0a0a;border-radius:10px;padding:18px;min-width:320px;max-width:520px;border:1px solid rgba(255,255,255,0.03);}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#081;color:#000;font-weight:700;}
  @media(max-width:820px){ .inline{flex-direction:column;align-items:flex-start;} button{width:100%;} }
</style>
</head>
<body>

<header>
  <h1>Zuckabot</h1>
  <p class="muted">Claim Portal â€” 200,000,000 ZUCKA giveaway â€¢ simple, on-chain, verifiable.</p>
</header>

<div id="notification" style="position:fixed;right:18px;top:18px;padding:12px 14px;border-radius:8px;display:none;z-index:9998;"></div>

<!-- Top: connect + key actions -->
<div class="card">
  <div class="inline">
    <div style="flex:1">
      <h2>Connect Wallet</h2>
      <p id="walletInfo" class="small">Not connected</p>
      <p class="small">Use MetaMask or Trust Wallet in-app browser. Connect to BSC Mainnet.</p>
    </div>
    <div style="min-width:220px;text-align:right">
      <button id="connectButton" class="btn-accent">Connect Wallet</button>
      <button id="addTokenBtn" class="btn-ghost">Add ZUCKA</button>
    </div>
  </div>
</div>

<!-- About / Marketing -->
<div class="card">
  <div class="inline" style="align-items:flex-start">
    <div style="flex:1">
      <h2>About Zuckabot â€” short and real</h2>
      <p class="small">
        Zuckabot is a community-first token built for virality and fairness. We're distributing a large launch pool (200,000,000 ZUCKA)
        via a simple, verifiable two-step claim flow. No hidden admin controls â€” token ownership is renounced and the distributor contract
        is open-source so anyone can audit claims and donations on-chain.
      </p>

      <h3 style="margin-top:12px">Why Zuckabot is different</h3>
      <ul class="small">
        <li><strong>Community-driven:</strong> a huge public giveaway to spread tokens widely and bootstrap organic adoption.</li>
        <li><strong>Verifiable:</strong> all contracts are published and verifiable on BscScan â€” the distributor simply forwards fees to the treasury and pays out tokens on-chain.</li>
        <li><strong>No surprise mechanics:</strong> standard ERC20 token, 1B fixed supply, ownership renounced â€” no minting magic.</li>
        <li><strong>Low barrier launch:</strong> planned PancakeSwap listing at <strong>$0.05</strong> to make early participation attractive.</li>
      </ul>
    </div>

    <aside style="min-width:260px">
      <div class="stat">
        <div class="small">Airdrop pool</div>
        <div style="font-weight:800;font-size:1.1rem">200,000,000 ZUCKA</div>
      </div>
      <div class="stat" style="margin-top:8px">
        <div class="small">Supply</div>
        <div style="font-weight:800;font-size:1.1rem">1,000,000,000 ZUCKA</div>
      </div>
      <div class="stat" style="margin-top:8px">
        <div class="small">Proposed Launch Price</div>
        <div style="font-weight:800;font-size:1.1rem">$0.05 on PancakeSwap</div>
      </div>
    </aside>
  </div>

  <div style="margin-top:12px" class="small">
    <strong>Short pitch:</strong> If a token can be both viral and verifiable â€” people keep it. Zuckabot aims to reward early supporters with an accessible launch price
    and a large public distribution so the community shapes the narrative.
  </div>
</div>

<!-- Tasks -->
<div class="card">
  <h2>Complete Social Tasks</h2>
  <p class="small">Optional: help the project get noticed. Proofs are stored locally only â€” never sent to a server.</p>

  <div class="inline" style="gap:10px">
    <div style="flex:1">
      <label class="small">Telegram â€” <a href="https://t.me/zuckabotofficial/1" target="_blank">join</a></label>
      <input id="telegramProof" placeholder="Paste proof link (Telegram)" />
    </div>
    <div style="width:180px">
      <button onclick="verifyTask('telegram')" class="btn-ghost">Verify</button>
      <span id="checkTelegram" style="display:none;margin-left:8px">âœ…</span>
    </div>
  </div>

  <div class="inline" style="gap:10px;margin-top:8px">
    <div style="flex:1">
      <label class="small">X (Twitter) â€” <a href="https://x.com/zuckabottoken" target="_blank">follow</a></label>
      <input id="xProof" placeholder="Paste proof link (X)" />
    </div>
    <div style="width:180px">
      <button onclick="verifyTask('x')" class="btn-ghost">Verify</button>
      <span id="checkX" style="display:none;margin-left:8px">âœ…</span>
    </div>
  </div>

  <div class="inline" style="gap:10px;margin-top:8px">
    <div style="flex:1">
      <label class="small">Facebook â€” <a href="https://web.facebook.com/profile.php?id=61579580776149" target="_blank">like</a></label>
      <input id="facebookProof" placeholder="Paste proof link (Facebook)" />
    </div>
    <div style="width:180px">
      <button onclick="verifyTask('facebook')" class="btn-ghost">Verify</button>
      <span id="checkFB" style="display:none;margin-left:8px">âœ…</span>
    </div>
  </div>

  <p class="small" style="margin-top:10px">Status: ðŸ”´ Pending â†’ ðŸŸ¡ Submitted â†’ ðŸŸ¢ Verified (auto after 10 minutes).</p>
</div>

<!-- Claim Card (fee hidden until finalize click) -->
<div class="card">
  <h2>Claim Your ZUCKA</h2>
  <p class="small">Two-step on-chain claim: Initiate (tx) â†’ wait 10 minutes â†’ Finalize (pay small on-chain fee). All operations are visible on BscScan.</p>

  <div class="inline">
    <div style="flex:1">
      <p class="small">Your claim allocation: <strong>1,500 ZUCKA</strong></p>
      <p id="claimStatus" class="small">Status: Not started</p>
      <p id="claimTimer" class="small">Time remaining: --:--</p>
    </div>

    <div style="min-width:220px;text-align:right">
      <button id="initiateBtn" class="btn-primary" disabled>Initiate Claim</button>
      <button id="finalizeBtn" class="btn-ghost" disabled>Finalize Claim</button>
    </div>
  </div>

  <p class="small" style="margin-top:12px">Note: fee amount is shown only when you finalize â€” press <em>Finalize Claim</em> and you'll see the exact BNB required before any payment is made.</p>
</div>

<!-- Stats & Contracts -->
<div class="card">
  <h2>On-chain Stats & Verified Contracts</h2>

  <div class="inline" style="align-items:flex-start">
    <div style="flex:1">
      <p class="small">Distributor token balance: <strong id="distTokenBalance">--</strong></p>
      <p class="small">Total Distributed: <strong id="totalClaimed">--</strong></p>
      <p class="small">Total Donations (BNB forwarded): <strong id="totalDonatedBNB">--</strong></p>
    </div>

    <div style="min-width:360px">
      <div style="margin-bottom:8px">
        <div class="small">Token (ZUCKA)</div>
        <div class="inline" style="align-items:center">
          <div class="address" id="tokenAddr">0x54bff3901d7d27ffe21b9a23bc8efb48c9847048</div>
          <button class="copy-btn" data-copy="0x54bff3901d7d27ffe21b9a23bc8efb48c9847048">Copy</button>
          <a class="small" style="margin-left:8px" href="https://bscscan.com/address/0x54bff3901d7d27ffe21b9a23bc8efb48c9847048#code" target="_blank">BscScan</a>
        </div>
      </div>

      <div style="margin-bottom:8px">
        <div class="small">Distributor</div>
        <div class="inline" style="align-items:center">
          <div class="address" id="distributorAddr">0xec222Dba73C17877773E411D15904bf205FbA149</div>
          <button class="copy-btn" data-copy="0xec222Dba73C17877773E411D15904bf205FbA149">Copy</button>
          <a class="small" style="margin-left:8px" href="https://bscscan.com/address/0xec222Dba73C17877773E411D15904bf205FbA149#code" target="_blank">BscScan</a>
        </div>
      </div>

      <div>
        <div class="small">Treasury</div>
        <div class="inline" style="align-items:center">
          <div class="address">0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91</div>
          <button class="copy-btn" data-copy="0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91">Copy</button>
          <a class="small" style="margin-left:8px" href="https://bscscan.com/address/0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91" target="_blank">BscScan</a>
        </div>
      </div>
    </div>
  </div>

  <hr style="border-color:#111;margin:12px 0" />
  <div class="small muted">Quick verification: Open each contract's <strong>Read Contract</strong> on BscScan and confirm the addresses & totals. All actions (initiate/finalize/donate) emit events you can inspect directly on-chain.</div>
</div>

<footer>
  Â©2025 Zuckabot â€¢ Distributor: 0xec222Dba73C17877773E411D15904bf205FbA149 â€¢ Treasury: 0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91
</footer>

<!-- Confirmation Modal (shown only when user clicks finalize) -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 style="margin-top:0">Finalize Claim â€” Confirm</h3>
    <div id="modalBody" class="small">
      <p>Fetching required feeâ€¦</p>
    </div>
    <div style="margin-top:12px;text-align:right">
      <button id="modalCancel" class="btn-ghost">Cancel</button>
      <button id="modalConfirm" class="btn-primary">Confirm & Pay</button>
    </div>
  </div>
</div>

<!-- Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script>
(() => {
  // ---------- CONFIG from you
  const TOKEN_ADDR = '0x54bff3901d7d27ffe21b9a23bc8efb48c9847048';
  const DISTRIBUTOR_ADDR = '0xec222Dba73C17877773E411D15904bf205FbA149';
  const TREASURY_ADDR = '0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91';
  const BSCSCAN_BASE = 'https://bscscan.com';

  // ABIs (as supplied)
  const tokenAbi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

  const distributorAbi = [{"inputs":[{"internalType":"address","name":"_zuckaToken","type":"address"},{"internalType":"address","name":"_priceFeed","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"zuckaAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bnbPaid","type":"uint256"}],"name":"ClaimFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"ClaimInitiated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"bnbAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"zuckaAmount","type":"uint256"}],"name":"Donated","type":"event"},{"inputs":[],"name":"BASE_RATE_PER_USD18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CLAIM_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CLAIM_FEE_USD18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TREASURY","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"donate","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"finalizeClaim","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"getLatestBNBPrice18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotals","outputs":[{"internalType":"uint256","name":"tokensDistributed","type":"uint256"},{"internalType":"uint256","name":"bnbCollectedWei","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasClaimed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initiateClaim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingClaimTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"priceFeed","outputs":[{"internalType":"contract AggregatorV3Interface","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"requiredClaimWei","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"secondsUntilFinalize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalClaimedTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDonatedBNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usd18","type":"uint256"}],"name":"usd18ToWei","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"weiAmount","type":"uint256"}],"name":"weiToUsd18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"zucka","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

  // Read-only provider
  const readProvider = new ethers.providers.JsonRpcProvider('https://bsc-dataseed.binance.org/');
  const distributorRead = new ethers.Contract(DISTRIBUTOR_ADDR, distributorAbi, readProvider);
  const tokenRead = new ethers.Contract(TOKEN_ADDR, tokenAbi, readProvider);

  // UI elements
  const notifyEl = document.getElementById('notification');
  const connectButton = document.getElementById('connectButton');
  const walletInfo = document.getElementById('walletInfo');
  const initiateBtn = document.getElementById('initiateBtn');
  const finalizeBtn = document.getElementById('finalizeBtn');
  const distTokenBalanceEl = document.getElementById('distTokenBalance');
  const totalClaimedEl = document.getElementById('totalClaimed');
  const totalDonatedEl = document.getElementById('totalDonatedBNB');
  const claimStatusEl = document.getElementById('claimStatus');
  const claimTimerEl = document.getElementById('claimTimer');
  const addTokenBtn = document.getElementById('addTokenBtn');

  // modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalBody = document.getElementById('modalBody');
  const modalCancel = document.getElementById('modalCancel');
  const modalConfirm = document.getElementById('modalConfirm');

  // copy buttons
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async (ev) => {
      const v = ev.currentTarget.getAttribute('data-copy');
      try {
        await navigator.clipboard.writeText(v);
        showNotification('Address copied', 'success');
      } catch(e) {
        showNotification('Copy failed â€” select & copy manually', 'error');
      }
    });
  });

  // simple notification
  function showNotification(msg, type='success', t=3800){
    notifyEl.textContent = msg;
    notifyEl.style.display = 'block';
    notifyEl.style.background = type === 'error' ? 'var(--danger)' : 'var(--success)';
    notifyEl.style.color = type === 'error' ? '#fff' : '#000';
    setTimeout(()=> { notifyEl.style.display = 'none'; }, t);
  }

  // format big numbers
  async function formatTokenAmount(raw, decimals) {
    try { return Number(ethers.utils.formatUnits(raw, decimals)).toLocaleString(undefined, {maximumFractionDigits: 6}); }
    catch(e){ return raw.toString(); }
  }

  // refresh read-only data
  async function refreshReadOnlyData(){
    try {
      const price18 = await distributorRead.getLatestBNBPrice18();
      // don't show fee here per your instruction, only used when finalizing
      const requiredWei = await distributorRead.requiredClaimWei(); // used on finalize

      const totals = await distributorRead.getTotals();
      const totalClaimed = totals.tokensDistributed;
      const totalDonatedWei = totals.bnbCollectedWei;

      const decimals = await tokenRead.decimals();
      const symbol = await tokenRead.symbol();
      const distBalRaw = await tokenRead.balanceOf(DISTRIBUTOR_ADDR);
      distTokenBalanceEl.textContent = (await formatTokenAmount(distBalRaw, decimals)) + ` ${symbol}`;

      totalClaimedEl.textContent = (await formatTokenAmount(totalClaimed, decimals)) + ` ${symbol}`;
      totalDonatedEl.textContent = (Number(ethers.utils.formatEther(totalDonatedWei))).toFixed(6) + ' BNB';
    } catch(err){
      console.error('read-only refresh failed', err);
      distTokenBalanceEl.textContent = '--';
      totalClaimedEl.textContent = '--';
      totalDonatedEl.textContent = '--';
    }
  }

  // wallet & signer
  let provider = null;
  let signer = null;
  let distributor = null;
  let token = null;
  let userAddress = null;

  // tasks local storage
  let tasks = {telegram:{verified:false}, x:{verified:false}, facebook:{verified:false}};
  try { const saved = JSON.parse(localStorage.getItem('zuckabotData')||'{}'); if (saved.tasks) tasks = saved.tasks; } catch(e){}

  // connect wallet
  async function connectWallet(){
    if (!window.ethereum){ showNotification('No wallet found â€” install MetaMask or use Trust Wallet', 'error'); return; }
    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      const net = await provider.getNetwork();
      if (net.chainId !== 56) {
        try {
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] });
          showNotification('Switched wallet to BSC Mainnet');
        } catch (switchErr) {
          // ask user to switch manually
          showNotification('Please switch wallet to BSC Mainnet', 'error', 6000);
        }
      }

      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      signer = provider.getSigner();

      distributor = new ethers.Contract(DISTRIBUTOR_ADDR, distributorAbi, signer);
      token = new ethers.Contract(TOKEN_ADDR, tokenAbi, signer);

      walletInfo.textContent = `Connected: ${userAddress.substring(0,6)}...${userAddress.slice(-4)}`;
      showNotification('Wallet connected');

      window.ethereum.on('accountsChanged', handleAccountsChanged);
      window.ethereum.on('chainChanged', () => { location.reload(); });

      await refreshReadOnlyData();
      await refreshUserState();
      updateButtons();
    } catch(err){
      console.error('connect failed', err);
      showNotification('Connection failed: ' + (err && err.message ? err.message : err), 'error', 5000);
    }
  }

  connectButton.addEventListener('click', connectWallet);

  function handleAccountsChanged(accounts){
    if (!accounts || accounts.length === 0) {
      walletInfo.textContent = 'Not connected';
      showNotification('Wallet disconnected', 'error');
      userAddress = null;
      distributor = null;
      token = null;
      updateButtons();
    } else {
      userAddress = accounts[0];
      walletInfo.textContent = `Connected: ${userAddress.substring(0,6)}...${userAddress.slice(-4)}`;
      refreshUserState();
      updateButtons();
    }
  }

  // add token to wallet
  async function addToken(){
    if (!window.ethereum){ showNotification('No wallet found', 'error'); return; }
    try {
      await window.ethereum.request({
        method: 'wallet_watchAsset',
        params: {
          type: 'ERC20',
          options: { address: TOKEN_ADDR, symbol: 'ZUCKA', decimals: 18, image: 'https://zuckabot.xyz/icon.png' }
        }
      });
      showNotification('Token add requested');
    } catch(e){ console.error(e); showNotification('Failed to add token', 'error'); }
  }
  addTokenBtn.addEventListener('click', addToken);

  // tasks verify (local)
  function verifyTask(task){
    const el = document.getElementById(task + 'Proof');
    if (!el) { showNotification('Proof input missing', 'error'); return; }
    const val = el.value.trim();
    if (!val){ showNotification('Paste a proof link before verifying', 'error'); return; }
    try { new URL(val); } catch(e){ showNotification('Invalid URL', 'error'); return; }

    tasks[task] = { verified: true, timestamp: Date.now() };
    document.getElementById('check'+task.charAt(0).toUpperCase()+task.slice(1)).style.display = 'inline';
    document.getElementById(task+'Status')?.textContent = 'Submitted';
    showNotification('Task submitted; it will auto-verify in 10 minutes');

    setTimeout(() => {
      document.getElementById(task+'Status')?.textContent = 'Verified';
      document.getElementById('check'+task.charAt(0).toUpperCase()+task.slice(1)).style.display = 'inline';
      tasks[task].verified = true;
      showNotification(`${task} verified`, 'success');
      saveLocal();
      updateButtons();
    }, 600000);

    saveLocal();
    updateButtons();
  }

  function saveLocal(){ localStorage.setItem('zuckabotData', JSON.stringify({tasks})); }

  // refresh user-specific state
  async function refreshUserState(){
    if (!distributor || !userAddress) return;
    try {
      const hasClaimed = await distributor.hasClaimed(userAddress);
      const pending = await distributor.pendingClaimTimestamp(userAddress);
      const secondsLeft = await distributor.secondsUntilFinalize(userAddress);

      if (hasClaimed) {
        claimStatusEl.textContent = 'Status: Already claimed';
        initiateBtn.disabled = true;
        finalizeBtn.disabled = true;
      } else if (pending && pending.toNumber() !== 0) {
        if (secondsLeft.toNumber() === 0) {
          claimStatusEl.textContent = 'Status: Ready to finalize';
          initiateBtn.disabled = true;
          finalizeBtn.disabled = false;
          startCountdown(0);
        } else {
          claimStatusEl.textContent = 'Status: Waiting verification (10m)';
          initiateBtn.disabled = true;
          finalizeBtn.disabled = true;
          startCountdown(secondsLeft.toNumber());
        }
      } else {
        claimStatusEl.textContent = 'Status: Not started';
        initiateBtn.disabled = false;
        finalizeBtn.disabled = true;
      }
    } catch(err) {
      console.error('refreshUserState', err);
      claimStatusEl.textContent = 'Status: Unknown';
    }
  }

  // countdown
  let countdownInterval = null;
  function startCountdown(seconds){
    clearInterval(countdownInterval);
    if (seconds === 0) { claimTimerEl.textContent = 'Ready to finalize!'; finalizeBtn.disabled = false; return; }
    let remaining = seconds;
    claimTimerEl.textContent = `Time remaining: ${formatRemaining(remaining)}`;
    countdownInterval = setInterval(() => {
      remaining = Math.max(0, remaining - 1);
      claimTimerEl.textContent = `Time remaining: ${formatRemaining(remaining)}`;
      if (remaining === 0) { clearInterval(countdownInterval); claimTimerEl.textContent = 'Ready to finalize!'; finalizeBtn.disabled = false; showNotification('Your claim is ready to finalize', 'success'); }
    }, 1000);
  }
  function formatRemaining(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

  // update buttons depending on tasks/wallet
  function updateButtons(){
    const allTasks = tasks.telegram && tasks.x && tasks.facebook && tasks.telegram.verified && tasks.x.verified && tasks.facebook.verified;
    initiateBtn.disabled = !(allTasks && !!userAddress && !!distributor);
  }

  // initiate claim (signed tx)
  initiateBtn.addEventListener('click', async () => {
    if (!distributor) { showNotification('Wallet not connected', 'error'); return; }
    try {
      initiateBtn.disabled = true;
      showNotification('Sending initiateClaim() transaction...');
      const tx = await distributor.initiateClaim();
      const rcpt = await tx.wait();
      showNotification('initiateClaim tx sent', 'success', 6000);
      window.open(`${BSCSCAN_BASE}/tx/${rcpt.transactionHash}`, '_blank');
      await refreshUserState();
    } catch(err){
      console.error('initiateClaim failed', err);
      showNotification('initiateClaim failed: ' + (err && err.message ? err.message : err), 'error', 6000);
      initiateBtn.disabled = false;
    }
  });

  // finalize flow: show modal with required fee, require user confirmation
  finalizeBtn.addEventListener('click', async () => {
    if (!distributor) { showNotification('Wallet not connected', 'error'); return; }
    try {
      // fetch required wei (live) and show to user before sending
      modalBody.innerHTML = '<p class="small">Fetching required feeâ€¦</p>';
      modalBackdrop.style.display = 'flex';

      const requiredWei = await distributor.requiredClaimWei();
      const requiredBNB = ethers.utils.formatEther(requiredWei);

      // show price & confirm text
      modalBody.innerHTML = `<p class="small">To finalize your claim, you will send <strong>${requiredBNB} BNB</strong> (this is the live conversion for the small claim fee).<br/>
      The transaction will forward the BNB to the public Treasury and you will receive 1,500 ZUCKA on-chain.</p>
      <p class="small muted">You will see a wallet confirmation next. No fee will be sent until you click <em>Confirm & Pay</em>.</p>`;

      // attach confirm handler (one-time)
      const onConfirm = async () => {
        modalConfirm.disabled = true;
        modalCancel.disabled = true;
        try {
          showNotification('Sending finalizeClaim() (you will confirm in wallet)...', 'success', 3000);
          const tx = await distributor.finalizeClaim({ value: requiredWei });
          const rcpt = await tx.wait();
          showNotification('Claim finalized!','success',7000);
          window.open(`${BSCSCAN_BASE}/tx/${rcpt.transactionHash}`, '_blank');
          await refreshReadOnlyData();
          await refreshUserState();
        } catch(err) {
          console.error('finalizeClaim failed', err);
          showNotification('finalizeClaim failed: ' + (err && err.message ? err.message : err), 'error', 6000);
        } finally {
          modalBackdrop.style.display = 'none';
          modalConfirm.disabled = false;
          modalCancel.disabled = false;
          modalConfirm.removeEventListener('click', onConfirm);
        }
      };

      modalConfirm.addEventListener('click', onConfirm);

      modalCancel.onclick = () => {
        modalBackdrop.style.display = 'none';
        modalConfirm.removeEventListener('click', onConfirm);
      };

    } catch(err){
      console.error('finalize prepare failed', err);
      showNotification('Failed to fetch fee: ' + (err && err.message ? err.message : err), 'error', 6000);
      modalBackdrop.style.display = 'none';
    }
  });

  // initial bootstrap
  (async function init(){
    try {
      if (tasks.telegram && tasks.telegram.verified) { document.getElementById('checkTelegram').style.display='inline'; }
      if (tasks.x && tasks.x.verified) { document.getElementById('checkX').style.display='inline'; }
      if (tasks.facebook && tasks.facebook.verified) { document.getElementById('checkFB').style.display='inline'; }
    } catch(e){}

    await refreshReadOnlyData();
    setInterval(refreshReadOnlyData, 30000);
    updateButtons();
  })();

})();
</script>
</body>
</html>
