<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zuckabot — Claim Portal</title>

<!-- ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

<style>
  :root{
    --bg:#051017; --card:#0b1720; --muted:#98a6b3; --primary:#00ff7a; --accent:#ffb86b; --danger:#ff6b6b;
    --glass: rgba(255,255,255,0.02); --maxw:980px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#021017);color:#e6eef6;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;line-height:1.45;padding:18px;}
  .wrap{max-width:var(--maxw);margin:0 auto;}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
  .brand {display:flex;flex-direction:column;}
  h1{color:var(--primary);margin:0;font-size:20px}
  p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg,var(--card),#061827);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,.6)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .col{flex:1;min-width:200px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--primary);color:#012}
  .btn-accent{background:var(--accent);color:#081018}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .small{font-size:0.92rem;color:var(--muted)}
  input[type=text], input[type=url] {width:100%;padding:9px;border-radius:8px;background:#081018;border:1px solid rgba(255,255,255,0.03);color:#eaf6ff}
  .muted{color:var(--muted)}
  .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
  code.addr{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:rgba(255,255,255,0.02);padding:6px;border-radius:8px;color:var(--muted);display:inline-block}
  .copy-btn{margin-left:8px;padding:6px 8px;border-radius:8px;background:#071018;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
  details{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  summary{cursor:pointer;font-weight:700}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .socials a{margin-left:8px;color:var(--muted);text-decoration:none}
  .spinner {display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.12);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-left:8px}
  @keyframes spin {to{transform:rotate(360deg)}}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.75);display:none;align-items:center;justify-content:center;padding:20px;z-index:1200}
  .modal{background:#061018;border-radius:12px;padding:18px;max-width:520px;width:100%;border:1px solid rgba(255,255,255,0.03)}
  @media (max-width:720px){ header{flex-direction:column;align-items:flex-start} .row{flex-direction:column;align-items:flex-start} .brand h1{font-size:18px} }
</style>
</head>
<body>

<div class="wrap">

  <header>
    <div class="brand">
      <h1>🚀 Zuckabot (ZUCKA)</h1>
      <p class="lead">200,000,000 giveaway • Fixed supply • Launch target $0.05 • www.zuckabot.xyz</p>
    </div>

    <div style="text-align:right">
      <div class="small">Wallet</div>
      <div id="walletInfo" style="font-weight:800">Not connected</div>
      <div style="margin-top:8px">
        <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
        <button id="disconnectBtn" class="btn btn-ghost" style="display:none">Disconnect</button>
      </div>
    </div>
  </header>

  <div id="notify" style="display:none;position:fixed;right:18px;top:18px;background:linear-gradient(90deg,var(--primary),#12c78a);padding:10px 14px;border-radius:10px;color:#012;z-index:1400"></div>

  <!-- Social proof tasks -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div class="col">
        <h3 style="margin:0 0 8px 0">Complete social tasks (required)</h3>
        <p class="small muted">Prove you joined/followed. Proofs are stored locally only (no server). Required to start a claim.</p>

        <div style="margin-top:12px;display:grid;gap:10px">
          <div class="row">
            <div style="flex:1">
              <div class="small">Telegram — <a target="_blank" href="https://t.me/zuckabotofficial/1" style="color:var(--primary)">Join</a></div>
              <input id="telegramProof" type="url" placeholder="Paste proof link (Telegram)" />
            </div>
            <div style="width:140px;text-align:right">
              <button class="btn btn-ghost" id="verifyTelegram">Verify</button>
              <div id="checkTelegram" style="display:inline-block;margin-left:8px"></div>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <div class="small">X (Twitter) — <a target="_blank" href="https://x.com/zuckabottoken" style="color:var(--primary)">Follow</a></div>
              <input id="xProof" type="url" placeholder="Paste proof link (X)" />
            </div>
            <div style="width:140px;text-align:right">
              <button class="btn btn-ghost" id="verifyX">Verify</button>
              <div id="checkX" style="display:inline-block;margin-left:8px"></div>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <div class="small">Facebook — <a target="_blank" href="https://web.facebook.com/profile.php?id=61579580776149" style="color:var(--primary)">Like</a></div>
              <input id="facebookProof" type="url" placeholder="Paste proof link (Facebook)" />
            </div>
            <div style="width:140px;text-align:right">
              <button class="btn btn-ghost" id="verifyFB">Verify</button>
              <div id="checkFB" style="display:inline-block;margin-left:8px"></div>
            </div>
          </div>
        </div>
      </div>

      <div style="min-width:220px">
        <div class="stat">
          <div class="small">Your allocation</div>
          <div style="font-weight:800;font-size:1.05rem">1,500 ZUCKA</div>
          <div class="small muted" style="margin-top:8px">Pool: <strong>200,000,000 ZUCKA</strong></div>
          <div style="margin-top:10px" class="small muted">Per-claim USD at $0.05: <strong>$75.00</strong></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Claim controls -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div class="col">
        <h3 style="margin:0 0 8px 0">Claim</h3>
        <p class="small muted">Two-step on-chain: <strong>Initiate</strong> → wait 10 minutes → <strong>Finalize</strong> (small BNB fee shown before you confirm).</p>

        <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
          <button id="initiateBtn" class="btn btn-primary" disabled>Initiate Claim</button>
          <button id="finalizeBtn" class="btn btn-accent" disabled>Finalize Claim</button>
        </div>

        <p id="claimStatus" class="small muted" style="margin-top:12px">Status: Not started</p>
        <p id="claimTimer" class="small muted">Time remaining: --:--</p>
      </div>

      <div style="min-width:220px">
        <div class="stat">
          <div class="small">Wallet ZUCKA balance</div>
          <div id="walletBalance" style="font-weight:800">-- ZUCKA</div>
          <div class="small muted" style="margin-top:8px">Value at $0.05: <span id="walletUsd">--</span></div>
          <div style="margin-top:10px"><button id="addTokenBtn" class="btn btn-ghost">Add ZUCKA to wallet</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats & Contracts -->
  <div class="card">
    <h3 style="margin:0 0 10px 0">On-chain Stats & Verified Contracts</h3>

    <div class="row">
      <div class="col stat" id="distBalance">Distributor token balance: --</div>
      <div class="col stat" id="totals">Total distributed: -- • Total donated: -- BNB</div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:12px">
      <div class="stat"><div class="small">Token (ZUCKA)</div>
        <div style="margin-top:6px"><code class="addr">0x54bff3901d7d27ffe21b9a23bc8efb48c9847048</code>
        <button class="copy-btn" data-copy="0x54bff3901d7d27ffe21b9a23bc8efb48c9847048">Copy</button>
        <a target="_blank" href="https://bscscan.com/address/0x54bff3901d7d27ffe21b9a23bc8efb48c9847048#readContract" class="small" style="margin-left:8px;color:var(--primary)">Read</a></div></div>

      <div class="stat"><div class="small">Distributor</div>
        <div style="margin-top:6px"><code class="addr">0xec222Dba73C17877773E411D15904bf205FbA149</code>
        <button class="copy-btn" data-copy="0xec222Dba73C17877773E411D15904bf205FbA149">Copy</button>
        <a target="_blank" href="https://bscscan.com/address/0xec222Dba73C17877773E411D15904bf205FbA149#readContract" class="small" style="margin-left:8px;color:var(--primary)">Read</a></div></div>

      <div class="stat"><div class="small">Treasury</div>
        <div style="margin-top:6px"><code class="addr">0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91</code>
        <button class="copy-btn" data-copy="0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91">Copy</button>
        <a target="_blank" href="https://bscscan.com/address/0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91" class="small" style="margin-left:8px;color:var(--primary)">View</a></div></div>

      <div class="stat"><div class="small">Supply</div><div style="font-weight:800">1,000,000,000 ZUCKA</div>
        <div style="margin-top:8px" class="small">Giveaway pool: 200,000,000 ZUCKA</div>
        <div style="margin-top:8px" class="small">Value of giveaway pool at $0.05: <strong id="poolUsd">--</strong></div>
      </div>
    </div>
  </div>

  <!-- FAQ -->
  <div class="card">
    <h3 style="margin:0 0 10px 0">FAQ</h3>

    <details style="margin-bottom:8px"><summary>Can I claim more than once?</summary>
      <div class="small muted" style="margin-top:8px">No. Each wallet can finalize exactly one claim. The contract tracks `hasClaimed` per address.</div>
    </details>

    <details style="margin-bottom:8px"><summary>Why is there a $0.25 fee?</summary>
      <div class="small muted" style="margin-top:8px">The $0.25 fee (converted to BNB live) prevents bot/spam claims, offsets gas, and helps bootstrap liquidity toward our PancakeSwap listing target of $0.05.</div>
    </details>

    <details style="margin-bottom:8px"><summary>When does finalize require the fee?</summary>
      <div class="small muted" style="margin-top:8px">The exact BNB fee is fetched from the distributor (`requiredClaimWei()`) and displayed in the finalize confirmation modal — you approve the transaction with that exact value.</div>
    </details>

    <details style="margin-bottom:8px"><summary>How do I verify contracts?</summary>
      <div class="small muted" style="margin-top:8px">Open the addresses on BscScan (links above). In the Read/Code tabs you can confirm `totalSupply()`, `owner()` and the distributor's `TREASURY()` address. All sources were provided and can be verified on-chain.</div>
    </details>

    <details><summary>Are proofs sent to a server?</summary>
      <div class="small muted" style="margin-top:8px">No. Social proof links are stored locally in your browser `localStorage` only and are never sent to any server.</div>
    </details>
  </div>

  <footer>
    <div class="socials small">Official: <a href="https://web.facebook.com/profile.php?id=61579580776149" target="_blank">Facebook</a> • <a href="https://t.me/zuckabotofficial/1" target="_blank">Telegram</a> • <a href="https://x.com/zuckabottoken" target="_blank">X</a></div>
    <div style="margin-top:8px" class="small muted">©2025 Zuckabot • Distributor: 0xec222Dba73C17877773E411D15904bf205FbA149 • Treasury: 0x42e8...c91</div>
  </footer>
</div>

<!-- modal -->
<div id="modal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 style="margin:0 0 8px 0">Finalize Claim — Confirm</h3>
    <p class="small muted" style="margin:0 0 12px 0">Finalize sends the small fee and receives <strong>1,500 ZUCKA</strong>. Confirm below to approve the on-chain payment.</p>

    <div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:12px">
      <div class="small">Fee: <strong id="modalFeeBnb">—</strong> BNB (<strong id="modalFeeUsd">—</strong> USD)</div>
      <div class="small muted" style="margin-top:6px">Treasury: <code class="addr">0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91</code></div>
    </div>

    <div style="text-align:right">
      <button id="modalCancel" class="btn btn-ghost">Cancel</button>
      <button id="modalConfirm" class="btn btn-primary">Confirm & Pay</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const TOKEN_ADDR = '0x54bff3901d7d27ffe21b9a23bc8efb48c9847048';
const DISTRIBUTOR_ADDR = '0xec222Dba73C17877773E411D15904bf205FbA149';
const TREASURY_ADDR = '0x42e8D84Ff8ff8e5EaE8E2648Ebfa772ee4515c91';
const LAUNCH_PRICE_USD = 0.05; // hardcoded launch price for USD calculations

/* ================ ABIs (provided) ================ */
/* Token ABI (trimmed to functions we use) */
const tokenAbi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

/* Distributor ABI (functions/events we use) */
const distributorAbi = [{"inputs":[{"internalType":"address","name":"_zuckaToken","type":"address"},{"internalType":"address","name":"_priceFeed","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"zuckaAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bnbPaid","type":"uint256"}],"name":"ClaimFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"ClaimInitiated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"bnbAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"zuckaAmount","type":"uint256"}],"name":"Donated","type":"event"},{"inputs":[],"name":"BASE_RATE_PER_USD18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CLAIM_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CLAIM_FEE_USD18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TREASURY","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"donate","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"finalizeClaim","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"getLatestBNBPrice18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotals","outputs":[{"internalType":"uint256","name":"tokensDistributed","type":"uint256"},{"internalType":"uint256","name":"bnbCollectedWei","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasClaimed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initiateClaim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingClaimTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"priceFeed","outputs":[{"internalType":"contract AggregatorV3Interface","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"requiredClaimWei","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"secondsUntilFinalize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalClaimedTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDonatedBNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usd18","type":"uint256"}],"name":"usd18ToWei","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"weiAmount","type":"uint256"}],"name":"weiToUsd18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"zucka","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

/* ================ STATE ================ */
const readProvider = new ethers.BrowserProvider(window?.ethereum || new ethers.JsonRpcProvider('https://bsc-dataseed.binance.org/'));
const distributorRead = new ethers.Contract(DISTRIBUTOR_ADDR, distributorAbi, readProvider);
const tokenRead = new ethers.Contract(TOKEN_ADDR, tokenAbi, readProvider);

let provider = null;
let signer = null;
let distributor = null;
let token = null;
let userAddress = null;

/* UI elements */
const notifyEl = document.getElementById('notify');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const walletInfo = document.getElementById('walletInfo');
const verifyTelegram = document.getElementById('verifyTelegram');
const verifyX = document.getElementById('verifyX');
const verifyFB = document.getElementById('verifyFB');
const checkTelegram = document.getElementById('checkTelegram');
const checkX = document.getElementById('checkX');
const checkFB = document.getElementById('checkFB');
const initiateBtn = document.getElementById('initiateBtn');
const finalizeBtn = document.getElementById('finalizeBtn');
const claimStatus = document.getElementById('claimStatus');
const claimTimer = document.getElementById('claimTimer');
const distBalanceEl = document.getElementById('distBalance');
const totalsEl = document.getElementById('totals');
const walletBalanceEl = document.getElementById('walletBalance');
const walletUsdEl = document.getElementById('walletUsd');
const poolUsdEl = document.getElementById('poolUsd');
const modalBackdrop = document.getElementById('modal');
const modalFeeBnb = document.getElementById('modalFeeBnb');
const modalFeeUsd = document.getElementById('modalFeeUsd');
const modalConfirm = document.getElementById('modalConfirm');
const modalCancel = document.getElementById('modalCancel');
const addTokenBtn = document.getElementById('addTokenBtn');
const downloadBtns = document.querySelectorAll('[data-copy]');

/* local tasks state */
let tasks = {telegram:{verified:false}, x:{verified:false}, facebook:{verified:false}};
try { const s = JSON.parse(localStorage.getItem('zuckabotData')||'{}'); if (s.tasks) tasks = s.tasks; } catch(e){}

/* ********** helpers ********** */
function showNotification(msg, type='info', t=3500){
  notifyEl.textContent = msg;
  notifyEl.style.display = 'block';
  notifyEl.style.background = type==='error' ? 'linear-gradient(90deg,var(--danger),#a10000)' : 'linear-gradient(90deg,var(--primary),#12c78a)';
  setTimeout(()=> notifyEl.style.display='none', t);
}
async function copyToClipboard(txt){ try { await navigator.clipboard.writeText(txt); showNotification('Copied to clipboard'); } catch(e){ showNotification('Copy failed', 'error'); } }

/* wire copy buttons */
document.querySelectorAll('[data-copy]').forEach(b=> b.addEventListener('click', ()=> copyToClipboard(b.getAttribute('data-copy'))));

/* tasks verify (local only) */
function verifyTask(task){
  const el = document.getElementById(task+'Proof');
  if (!el) return showNotification('Missing input','error');
  const url = el.value.trim();
  if (!url) return showNotification('Paste proof link before verifying','error');
  try { new URL(url); } catch(e){ return showNotification('Invalid URL','error'); }
  // mark submitted and auto-verify after 10 minutes (mirrors contract wait)
  if (!tasks) tasks = {};
  tasks[task] = {verified:false, ts: Date.now()};
  const checkEl = document.getElementById('check'+(task==='x'?'X':'')+task.slice(1));
  checkEl.textContent = '⏳';
  showNotification('Submitted — will auto-verify in 10 minutes', 'info', 3500);
  setTimeout(()=> {
    tasks[task].verified = true;
    checkEl.textContent = '✅';
    localStorage.setItem('zuckabotData', JSON.stringify({tasks}));
    updateButtons();
    showNotification(`${task} verified`, 'info', 2000);
  }, 600000);
  localStorage.setItem('zuckabotData', JSON.stringify({tasks}));
  updateButtons();
}
window.verifyTask = verifyTask;
verifyTelegram.addEventListener('click', ()=> verifyTask('telegram'));
verifyX.addEventListener('click', ()=> verifyTask('x'));
verifyFB.addEventListener('click', ()=> verifyTask('facebook'));

/* calculate pool USD value */
(function setPoolUsd(){
  const poolTokens = 200_000_000;
  poolUsdEl.textContent = `$${(poolTokens * LAUNCH_PRICE_USD).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
})();

/* read-only refresh */
async function refreshReadOnlyData(){
  try{
    const totals = await distributorRead.getTotals();
    // BigInt values from ethers v6
    const tokensDistributed = totals.tokensDistributed;
    const bnbCollectedWei = totals.bnbCollectedWei;

    const decimals = Number(await tokenRead.decimals());
    const symbol = await tokenRead.symbol();

    const distBalRaw = await tokenRead.balanceOf(DISTRIBUTOR_ADDR);
    const distBal = Number(ethers.formatUnits(distBalRaw, decimals));
    distBalanceEl.textContent = `Distributor token balance: ${distBal.toLocaleString(undefined,{maximumFractionDigits:6})} ${symbol}`;

    const totalDistNum = Number(ethers.formatUnits(tokensDistributed, decimals));
    const totalDonated = Number(ethers.formatEther(bnbCollectedWei));
    totalsEl.textContent = `Total distributed: ${totalDistNum.toLocaleString(undefined,{maximumFractionDigits:6})} ${symbol} • Total donated: ${totalDonated.toFixed(6)} BNB`;

  } catch(err){
    console.error('refreshReadOnlyData', err);
    distBalanceEl.textContent = 'Distributor token balance: Unavailable';
    totalsEl.textContent = 'Total distributed: --';
  }
}

/* provider connect (injected wallets) */
connectBtn.addEventListener('click', async ()=>{
  if (!window.ethereum) return showNotification('No injected wallet found — use MetaMask or your wallet app browser', 'error', 6000);
  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    walletInfo.textContent = `Connected: ${userAddress.substring(0,6)}...${userAddress.slice(-4)}`;
    // instantiate writeable contracts
    distributor = new ethers.Contract(DISTRIBUTOR_ADDR, distributorAbi, signer);
    token = new ethers.Contract(TOKEN_ADDR, tokenAbi, signer);

    connectBtn.style.display = 'none';
    disconnectBtn.style.display = 'inline-block';

    showNotification('Wallet connected', 'info', 2000);
    await refreshReadOnlyData();
    await refreshUserState();
    updateButtons();

    // detect account / chain changes
    window.ethereum.on && window.ethereum.on('accountsChanged', (accounts) => {
      if (!accounts || accounts.length === 0) {
        disconnectWallet();
      } else {
        userAddress = accounts[0];
        walletInfo.textContent = `Connected: ${userAddress.substring(0,6)}...${userAddress.slice(-4)}`;
        refreshUserState();
      }
    });
    window.ethereum.on && window.ethereum.on('chainChanged', ()=> location.reload());
  } catch(err){
    console.error('connect error', err);
    showNotification('Connection failed: ' + (err && err.message ? err.message : err), 'error', 5000);
  }
});

disconnectBtn.addEventListener('click', ()=> disconnectWallet());
function disconnectWallet(){
  provider = null; signer = null; distributor = null; token = null; userAddress = null;
  walletInfo.textContent = 'Not connected';
  connectBtn.style.display = 'inline-block';
  disconnectBtn.style.display = 'none';
  updateButtons();
}

/* add token helper */
addTokenBtn.addEventListener('click', async ()=>{
  if (!window.ethereum) return showNotification('No wallet found', 'error');
  try {
    await window.ethereum.request({
      method: 'wallet_watchAsset',
      params: { type: 'ERC20', options: { address: TOKEN_ADDR, symbol: 'ZUCKA', decimals: 18, image: 'https://zuckabot.xyz/icon.png' } }
    });
    showNotification('Token add requested', 'info');
  } catch(e){ console.error(e); showNotification('Failed to add token', 'error'); }
});

/* update UI enabled / disabled for buttons based on tasks & wallet */
function updateButtons(){
  const allTasks = tasks && tasks.telegram && tasks.x && tasks.facebook && tasks.telegram.verified && tasks.x.verified && tasks.facebook.verified;
  initiateBtn.disabled = !(allTasks && !!userAddress && !!distributor);
}

/* refresh user-specific state */
async function refreshUserState(){
  if (!distributor || !userAddress) return;
  try{
    const hasClaimed = await distributor.hasClaimed(userAddress);
    const pending = await distributor.pendingClaimTimestamp(userAddress);
    const secondsLeft = await distributor.secondsUntilFinalize(userAddress);

    // wallet token balance (read via tokenRead for accurate decimals)
    const decimals = Number(await tokenRead.decimals());
    const balRaw = await tokenRead.balanceOf(userAddress);
    const bal = Number(ethers.formatUnits(balRaw, decimals));
    walletBalanceEl.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:6})} ZUCKA`;
    walletUsdEl.textContent = `$${(bal * LAUNCH_PRICE_USD).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;

    if (hasClaimed) {
      claimStatus.textContent = 'Status: Already claimed';
      initiateBtn.disabled = true;
      finalizeBtn.disabled = true;
      claimTimer.textContent = '';
    } else if (pending && pending !== 0n) {
      if (secondsLeft === 0n) {
        claimStatus.textContent = 'Status: Ready to finalize';
        initiateBtn.disabled = true;
        finalizeBtn.disabled = false;
        startCountdown(0);
      } else {
        claimStatus.textContent = 'Status: Waiting verification (10m)';
        initiateBtn.disabled = true;
        finalizeBtn.disabled = true;
        startCountdown(Number(secondsLeft));
      }
    } else {
      claimStatus.textContent = 'Status: Not started';
      claimTimer.textContent = '';
      initiateBtn.disabled = !(tasks.telegram && tasks.x && tasks.facebook && tasks.telegram.verified && tasks.x.verified && tasks.facebook.verified && !!userAddress);
      finalizeBtn.disabled = true;
    }
  } catch(err){
    console.error('refreshUserState', err);
    claimStatus.textContent = 'Status: Unknown';
  }
}

/* countdown */
let countdownInterval = null;
function startCountdown(seconds){
  clearInterval(countdownInterval);
  if (seconds === 0) { claimTimer.textContent = 'Ready to finalize!'; finalizeBtn.disabled = false; return; }
  let remaining = seconds;
  claimTimer.textContent = `Time remaining: ${formatRemaining(remaining)}`;
  countdownInterval = setInterval(()=> {
    remaining = Math.max(0, remaining - 1);
    claimTimer.textContent = `Time remaining: ${formatRemaining(remaining)}`;
    if (remaining === 0) { clearInterval(countdownInterval); claimTimer.textContent = 'Ready to finalize!'; finalizeBtn.disabled = false; showNotification('Your claim is ready to finalize'); }
  }, 1000);
}
function formatRemaining(sec){ const m = Math.floor(sec/60); const s = sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

/* Initiate Claim */
initiateBtn.addEventListener('click', async ()=>{
  if (!distributor || !userAddress) return showNotification('Connect wallet and complete social tasks first', 'error');
  try {
    initiateBtn.disabled = true;
    const spinner = createSpinner(initiateBtn);
    showNotification('Sending initiateClaim transaction...', 'info');
    const tx = await distributor.initiateClaim();
    await tx.wait();
    showNotification('Initiate transaction confirmed', 'info', 5000);
    removeSpinner(initiateBtn, spinner);
    await refreshUserState();
    await refreshReadOnlyData();
  } catch(err){
    console.error('initiate error', err);
    showNotification('initiate failed: ' + (err && err.message ? err.message : err), 'error', 7000);
    initiateBtn.disabled = false;
  }
});

/* Finalize Claim -> show modal with live fee and USD equivalent */
finalizeBtn.addEventListener('click', async ()=>{
  if (!distributor || !userAddress) return showNotification('Connect wallet first', 'error');
  try {
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
    modalFeeBnb.textContent = '…';
    modalFeeUsd.textContent = '…';

    const requiredWei = await distributor.requiredClaimWei();
    const requiredBnb = Number(ethers.formatEther(requiredWei));
    modalFeeBnb.textContent = requiredBnb;

    // get price using getLatestBNBPrice18 to compute USD: price18 is USD * 1e18
    try {
      const price18 = await distributor.getLatestBNBPrice18();
      const priceUsd = Number(ethers.formatUnits(price18, 18)); // USD per 1 BNB
      const usdVal = requiredBnb * priceUsd;
      modalFeeUsd.textContent = `$${usdVal.toFixed(4)}`;
    } catch(e){
      modalFeeUsd.textContent = 'N/A';
    }

    /* Confirm handler */
    const onConfirm = async ()=> {
      modalConfirm.disabled = true;
      modalCancel.disabled = true;
      const spinner = createSpinner(modalConfirm);
      try {
        showNotification('Sending finalizeClaim — approve in wallet', 'info', 4000);
        const tx = await distributor.finalizeClaim({ value: requiredWei });
        await tx.wait();
        showNotification('Claim finalized — tokens should now be in your wallet', 'info', 6000);
        modalBackdrop.style.display = 'none';
        await refreshReadOnlyData();
        await refreshUserState();
      } catch(err){
        console.error('finalize error', err);
        showNotification('finalize failed: ' + (err && err.message ? err.message : err), 'error', 7000);
      } finally {
        modalConfirm.disabled = false;
        modalCancel.disabled = false;
        removeSpinner(modalConfirm, spinner);
        modalConfirm.removeEventListener('click', onConfirm);
      }
    };

    modalConfirm.addEventListener('click', onConfirm);
    modalCancel.onclick = ()=> {
      modalBackdrop.style.display = 'none';
      modalConfirm.removeEventListener('click', onConfirm);
    };

  } catch(err){
    console.error('prepare finalize failed', err);
    showNotification('Failed to fetch fee: ' + (err && err.message ? err.message : err), 'error', 5000);
    modalBackdrop.style.display = 'none';
  }
});

/* spinner helpers */
function createSpinner(btn){
  const s = document.createElement('span'); s.className='spinner';
  btn.appendChild(s); return s;
}
function removeSpinner(btn, spinner){ spinner && spinner.remove(); }

/* initial bootstrap */
(async function init(){
  await refreshReadOnlyData();
  setInterval(refreshReadOnlyData, 30000);
  updateButtons();
})();

/* helper to show wallet-specific token balance & USD value on connect */
async function fetchWalletTokenValue(){
  if (!userAddress) return;
  try {
    const decimals = Number(await tokenRead.decimals());
    const balRaw = await tokenRead.balanceOf(userAddress);
    const bal = Number(ethers.formatUnits(balRaw, decimals));
    walletBalanceEl.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:6})} ZUCKA`;
    walletUsdEl.textContent = `$${(bal * LAUNCH_PRICE_USD).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
  } catch(e){
    console.error('wallet value', e);
  }
}

/* call refreshUserState and wallet token value whenever needed */
async function refreshUserState(){
  // implemented earlier; but ensure wallet token value updated too
  if (!distributor || !userAddress) return;
  try{
    const hasClaimed = await distributor.hasClaimed(userAddress);
    const pending = await distributor.pendingClaimTimestamp(userAddress);
    const secondsLeft = await distributor.secondsUntilFinalize(userAddress);

    const decimals = Number(await tokenRead.decimals());
    const balRaw = await tokenRead.balanceOf(userAddress);
    const bal = Number(ethers.formatUnits(balRaw, decimals));
    walletBalanceEl.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:6})} ZUCKA`;
    walletUsdEl.textContent = `$${(bal * LAUNCH_PRICE_USD).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;

    if (hasClaimed) {
      claimStatus.textContent = 'Status: Already claimed';
      initiateBtn.disabled = true; finalizeBtn.disabled = true; claimTimer.textContent = '';
    } else if (pending && pending !== 0n) {
      if (secondsLeft === 0n) {
        claimStatus.textContent = 'Status: Ready to finalize';
        initiateBtn.disabled = true; finalizeBtn.disabled = false; startCountdown(0);
      } else {
        claimStatus.textContent = 'Status: Waiting verification (10m)';
        initiateBtn.disabled = true; finalizeBtn.disabled = true; startCountdown(Number(secondsLeft));
      }
    } else {
      claimStatus.textContent = 'Status: Not started';
      claimTimer.textContent = '';
      initiateBtn.disabled = !(tasks.telegram && tasks.x && tasks.facebook && tasks.telegram.verified && tasks.x.verified && tasks.facebook.verified && !!userAddress);
      finalizeBtn.disabled = true;
    }
  } catch(err){ console.error(err); }
}

/* Expose verifyTask externally (already done) */
</script>
</body>
</html>
